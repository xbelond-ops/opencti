services:
  # Génération de clé RSA pour XTM Composer (PKCS#8 4096 bits)
  rsa-key-generator:
    image: alpine/openssl:3.5.2
    volumes:
      - rsakeys:/keys
    entrypoint: ["/bin/ash"]
    command: ["-c", "if [ ! -f /keys/private_key.pem ]; then openssl genpkey -algorithm RSA -out /keys/private_key.pem -pkeyopt rsa_keygen_bits:4096; fi && tail -f /dev/null"]
    healthcheck:
      test: ["CMD", "test", "-f", "/keys/private_key.pem"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

  redis:
    image: redis:7.4
    restart: always
    volumes:
      - redisdata:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.19.2
    environment:
      discovery.type: "single-node"
      xpack.ml.enabled: "false"
      xpack.security.enabled: "false"
      thread_pool.search.queue_size: "5000"
      logger.org.elasticsearch.discovery: "ERROR"
	  #atteantion à la mémoire!
      ES_JAVA_OPTS: "-Xms30g -Xmx30g"
	  bootstrap.memory_lock: "true"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - esdata:/usr/share/elasticsearch/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:9200/_cluster/health?wait_for_status=yellow >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 50

  minio:
    image: minio/minio:RELEASE.2025-06-13T11-33-47Z
    command: server /data
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
    volumes:
      - s3data:/data
    ports:
      - "9000:9000"
    restart: always

  rabbitmq:
    image: rabbitmq:4.1-management
    environment:
      RABBITMQ_DEFAULT_USER: "${RABBITMQ_DEFAULT_USER}"
      RABBITMQ_DEFAULT_PASS: "${RABBITMQ_DEFAULT_PASS}"
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - amqpdata:/var/lib/rabbitmq
    restart: always
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 30s
      retries: 3

  opencti:
    image: opencti/platform:6.8.10
    environment:
      NODE_OPTIONS: "--max-old-space-size=8096"
      APP__PORT: "8080"
      APP__BASE_URL: "${OPENCTI_BASE_URL}"
      APP__ADMIN__EMAIL: "${OPENCTI_ADMIN_EMAIL}"
      APP__ADMIN__PASSWORD: "${OPENCTI_ADMIN_PASSWORD}"
      APP__ADMIN__TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      APP__APP_LOGS__LOGS_LEVEL: "error"
      REDIS__HOSTNAME: "redis"
      REDIS__PORT: "6379"
      ELASTICSEARCH__URL: "http://elasticsearch:9200"
      ELASTICSEARCH__NUMBER_OF_REPLICAS: "0"
      MINIO__ENDPOINT: "minio"
      MINIO__PORT: "9000"
      MINIO__USE_SSL: "false"
      MINIO__ACCESS_KEY: "${MINIO_ROOT_USER}"
      MINIO__SECRET_KEY: "${MINIO_ROOT_PASSWORD}"
      MINIO__BUCKET_NAME: "opencti"
      MINIO__USE_PATH_STYLE: "true"
      RABBITMQ__HOSTNAME: "rabbitmq"
      RABBITMQ__PORT: "5672"
      RABBITMQ__PORT_MANAGEMENT: "15672"
      RABBITMQ__MANAGEMENT_SSL: "false"
      RABBITMQ__USERNAME: "${RABBITMQ_DEFAULT_USER}"
      RABBITMQ__PASSWORD: "${RABBITMQ_DEFAULT_PASS}"
      SMTP__HOSTNAME: "${SMTP_HOSTNAME}"
      SMTP__PORT: "25"
      PROVIDERS__LOCAL__STRATEGY: "LocalStrategy"
      APP__HEALTH_ACCESS_KEY: "${OPENCTI_HEALTHCHECK_ACCESS_KEY}"
      OPENCTI_NOTIFIERS: true
    ports:
      - "8080:8080"
    depends_on:
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_started
      minio:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://opencti:8080/health?health_access_key=${OPENCTI_HEALTHCHECK_ACCESS_KEY} >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  worker:
    image: opencti/worker:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      WORKER_LOG_LEVEL: "info"
    depends_on:
      opencti:
        condition: service_healthy
    deploy:
      mode: replicated
      replicas: 5
    restart: always

  # === XTM Composer (Integration Manager) ===
  xtm-composer:
    image: filigran/xtm-composer:1.0.0
    platform: linux/amd64
    environment:
      MANAGER__ID: "${XTM_COMPOSER_ID}"
      MANAGER__NAME: "OpenCTI Connector Manager"
      MANAGER__CREDENTIALS_KEY_FILEPATH: "/keys/private_key.pem"
      OPENCTI__ENABLE: "true"
      OPENCTI__URL: "http://opencti:8080"
      OPENCTI__TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      OPENCTI__DAEMON__SELECTOR: "docker"
      OPENCTI__DAEMON__DOCKER__NETWORK_MODE: "${COMPOSE_PROJECT_NAME}_default"
    volumes:
      - rsakeys:/keys
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      rsa-key-generator:
        condition: service_healthy
      opencti:
        condition: service_healthy
    restart: always

  # === CONNECTEURS D’EXPORT / IMPORT ===
  connector-export-file-stix:
    image: opencti/connector-export-file-stix:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      CONNECTOR_ID: "${CONNECTOR_EXPORT_FILE_STIX_ID}"
      CONNECTOR_TYPE: "INTERNAL_EXPORT_FILE"
      CONNECTOR_NAME: "ExportFileStix2"
      CONNECTOR_SCOPE: "application/json"
      CONNECTOR_LOG_LEVEL: "info"
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-export-file-csv:
    image: opencti/connector-export-file-csv:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      CONNECTOR_ID: "${CONNECTOR_EXPORT_FILE_CSV_ID}"
      CONNECTOR_TYPE: "INTERNAL_EXPORT_FILE"
      CONNECTOR_NAME: "ExportFileCsv"
      CONNECTOR_SCOPE: "text/csv"
      CONNECTOR_LOG_LEVEL: "info"
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-export-file-txt:
    image: opencti/connector-export-file-txt:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      CONNECTOR_ID: "${CONNECTOR_EXPORT_FILE_TXT_ID}"
      CONNECTOR_TYPE: "INTERNAL_EXPORT_FILE"
      CONNECTOR_NAME: "ExportFileTxt"
      CONNECTOR_SCOPE: "text/plain"
      CONNECTOR_LOG_LEVEL: "info"
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-import-file-stix:
    image: opencti/connector-import-file-stix:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      CONNECTOR_ID: "${CONNECTOR_IMPORT_FILE_STIX_ID}"
      CONNECTOR_TYPE: "INTERNAL_IMPORT_FILE"
      CONNECTOR_NAME: "ImportFileStix"
      CONNECTOR_VALIDATE_BEFORE_IMPORT: "true"
      CONNECTOR_SCOPE: "application/json,text/xml"
      CONNECTOR_AUTO: "true"
      CONNECTOR_LOG_LEVEL: "info"
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

  connector-import-document:
    image: opencti/connector-import-document:6.8.10
    environment:
      OPENCTI_URL: "http://opencti:8080"
      OPENCTI_TOKEN: "${OPENCTI_ADMIN_TOKEN}"
      CONNECTOR_ID: "${CONNECTOR_IMPORT_DOCUMENT_ID}"
      CONNECTOR_TYPE: "INTERNAL_IMPORT_FILE"
      CONNECTOR_NAME: "ImportDocument"
      CONNECTOR_VALIDATE_BEFORE_IMPORT: "true"
      CONNECTOR_SCOPE: "application/pdf,text/plain,text/html"
      CONNECTOR_AUTO: "true"
      CONNECTOR_ONLY_CONTEXTUAL: "false"
      CONNECTOR_LOG_LEVEL: "info"
      IMPORT_DOCUMENT_CREATE_INDICATOR: "true"
    restart: always
    depends_on:
      opencti:
        condition: service_healthy

